<div id="shopifyAlertModal" class="modal-overlay">
  <div class="alert-modal-content">
    <img id="alertImage" src="" alt="Alert Image" style="max-width: 100%; height: auto; display: none;" width="100" height="100"/>
    <h2 id="alertTitle"></h2>
    <p id="alertDescription"></p>
    <label for="dontShowAgain" id="dontShowAgainWrapper">
      <input type="checkbox" id="dontShowAgain" /> Don't show this again
    </label>
    <div class="alert-modal-actions">
      <button id="alertSecondaryBtn" class="secondary-btn">Cancel</button>
      <button id="alertPrimaryBtn" class="primary-btn">OK</button>
    </div>
    <div id="watermark" class="watermark">Powered by Poppy</div>
  </div>
</div>


<style>
  :root {
    --title-text-color: {{ block.settings.title_text_color }};
    --description-text-color: {{ block.settings.description_text_color }};
    --primary-button-color: {{ block.settings.primary_button_color }};
    --secondary-button-color: {{ block.settings.secondary_button_color }};
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    handleShopifyAlertModals();
  });

  function handleShopifyAlertModals() {
    console.log("游댃 Poppy is Running");
    const billingMetaobject = {{ metaobjects['poppy-billing'].values | json }};
    console.log(billingMetaobject);
      
    const planType = !billingMetaobject ? 'free' : billingMetaobject[0].plan;

console.log(planType);


    const currentProduct = {{ product |  json}};
    const currentCollections = {{ product.collections |  json}};
    console.log(currentProduct)
    const currentUser = "{{ customer }}";
    const country = "{{ localization.country.iso_code }}";
    const modal = document.getElementById('shopifyAlertModal');
    const primaryBtn = document.getElementById('alertPrimaryBtn');
    const secondaryBtn = document.getElementById('alertSecondaryBtn');
    const dontShowAgain = document.getElementById('dontShowAgain');
  const isProductPage = {% if template == 'product' %}true{% else %}false{% endif %};
    let interceptedAction = null;

    if (!modal) {
      console.debug("丘멆잺 Modal or close button not found.");
      return;
    }

    const allMetaobjects = [];
    {% for metaobject in metaobjects['alertium-by-konain-bhai'].values %}
      {% if metaobject.alertStatus == "Active" %}
        allMetaobjects.push({{ metaobject | json }});
      {% endif %}
    {% endfor %}

    console.log("游리 Loaded Active Metaobjects:", allMetaobjects);

    // Loop over each active metaobject and attach behavior
    let maintainanceShown = false;

allMetaobjects.forEach(meta => {
  // Country check
  if (meta.countryRestriction === "enable" && !meta.selectedCountries.includes(country)) return;

  // User check
  if (meta.userOnly === "enable" && !currentUser) return;

  // Schedule check
  if (meta.scheduleStatus === "enable" && planType === "pro") {
    const now = new Date();
    const start = new Date(meta.startDate);
    const end = new Date(meta.endDate);
    if (now < start || now > end) return;
  }
  console.log("Alert:", meta)

  const showPosition = meta.showPosition;
  const popupImage = meta.popupImage;

  // Ensure both selectedCollections and currentProduct.collections have comparable IDs
  const selectedCollectionIds = (
    Array.isArray(meta.selectedCollections) && meta.selectedCollections.length > 0
  ) ? meta.selectedCollections.map(collectionGid => {
    return collectionGid.split('/').pop(); // Extract the collection ID from the GID
  }) : [];

  // Evaluate product and collection matching condition
  const isProductOrCollectionMatch =
  (meta.selectBy === "products" && (() => {
    const id = currentProduct?.id?.toString();
    const selectedProducts = Array.isArray(meta.selectedProducts) ? meta.selectedProducts : [];
    const match = selectedProducts.some(p => p.split("/").pop() === id);

    console.log("Product Match:", { id, selectedProducts, match });
    return match;
  })()) ||
  (meta.selectBy === "collections" && Array.isArray(currentCollections) && currentCollections.some(c => {
    const id = c.id.toString();
    const match = selectedCollectionIds.includes(id);

    console.log("Collection Match:", { id, selectedCollectionIds, match });
    return match;
  }));



  // Show maintenance modal first (priority)
  if (showPosition === "maintainance" && !maintainanceShown) {
    displayModal(meta);
    maintainanceShown = true;
    console.log("游닉 Showing maintenance modal");

    return; // Exit loop after showing the "maintainance" modal
  }

  // Show sitewite modal if maintenance hasn't been shown and sitewite is available
  if (showPosition === "sitewite" && !maintainanceShown && !isProductPage) {
    console.log("游닉 Showing sitewide modal");
    interceptedAction = "sitewite";
    displayModal(meta);
    return;
  }

  // Show close intent modal when the user is about to leave the page
  if (showPosition === "closeIntent" && planType === "pro" ) {
    
    document.addEventListener('mouseout', function (event) {
      // Check if the mouse is leaving the window
      if (event.relatedTarget === null && modal.style.display !== "flex") {
        console.log('Mouse has left the window or document area!');
        // Your custom logic here
        displayModal(meta);
      }
    });
    
    return;
  }
  

  // Show modal when user clicks "Add to Cart" button
  if (showPosition === "addToCart" && isProductOrCollectionMatch) {
    const addBtn = document.querySelector('[name="add"]');
    if (addBtn) {
      const clone = addBtn.cloneNode(true);
      addBtn.parentNode.replaceChild(clone, addBtn);
      clone.addEventListener('click', function (e) {
        e.preventDefault();
        interceptedAction = "addToCart";
        displayModal(meta);
        console.log("游닉 Showing add-to-cart modal");
      });
    }
  }

  // Show modal when product page is loaded
  if (showPosition === "productPage" && isProductOrCollectionMatch && planType === "pro") {
    displayModal(meta);
    console.log("游닉 Showing product page modal");
  }

  // Show modal when Buy Now button is clicked
  if (showPosition === "buynow" && isProductOrCollectionMatch) {
    const checkoutSelectors = [
      'button[name="checkout"]',
      'input[name="checkout"]',
      'button[name="direct_checkout"]',
      'button[data-shopify-buy-now-button]',
      '.shopify-payment-button__button'
    ];

    checkoutSelectors.forEach(selector => {
      const btn = document.querySelector(selector);
      if (btn) {
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);
        clone.addEventListener('click', function (e) {
          e.preventDefault();
          interceptedAction = "checkout";
          displayModal(meta); // Display the modal when checkout is intercepted
          console.log("游닉 Showing buy now modal");
        });
      }
    });
  }
});


    function displayModal(meta) {
      console.log("游닉 Showing modal:", meta.title);
      modal.style.display = "flex";

      document.getElementById('alertTitle').textContent = meta.title || "Notice";
      document.getElementById('alertDescription').textContent = meta.description || "";
      primaryBtn.textContent = meta.primaryText || "OK";
      secondaryBtn.textContent = meta.secondaryText || "Cancel";
      const modalImage = document.getElementById("alertImage");
      const doNotShowAgain = document.getElementById("dontShowAgainWrapper")
      if (meta.image) {
    modalImage.src = meta.image; // Set the image source dynamically
    modalImage.style.display = "block"; // Show the image
  } else {
    modalImage.style.display = "none"; // Hide the image if not available
  }
  const watermark = document.getElementById("watermark");
  if(meta.removeWatermark == "true" && planType !== "pro"){
    watermark.style.display = "block"; 

  }
  if(meta.showPosition === "maintainance"){
    doNotShowAgain.style.display = "none"
    primaryBtn.style.display = "none";
    secondaryBtn.style.display = "none"

  }
      primaryBtn.onclick = () => {
        if (dontShowAgain?.checked) {
          sessionStorage.setItem('poppyAlertDismissed', 'true');
        }
        modal.style.display = "none";
        if (interceptedAction === "addToCart") {
  const forms = document.querySelectorAll('form[action^="/cart/add"]');
  
  if (forms && forms.length > 1) {
    forms[0].submit();  // Submit the second form (index 1)
  } else {
    console.error('Form not found for adding to cart.');
  }
}


        if (interceptedAction === "checkout") {
          window.location.href = "/checkout";
        }
      };

      secondaryBtn.onclick = () => {
        modal.style.display = "none";
        if (meta.showPosition === "productPage") {
          window.location.href = "/";
        }
        if (meta.showPosition === "sitewite") {
          window.location.reload();
        }
      };
    }
  }
</script>







{% schema %}
{
  "name": "Poppy",
  "target": "body",
  "stylesheet": "styles.css",
  
  "settings": [
    {
      "type": "color",
      "id": "title_text_color",
      "label": "Title Text Color",
      "default": "#007acc"
    },
    {
      "type": "color",
      "id": "description_text_color",
      "label": "Description Text Color",
      "default": "#555555"
    },
    {
      "type": "color",
      "id": "primary_button_color",
      "label": "Primary Button Color",
      "default": "#007acc"
    },
    {
      "type": "color",
      "id": "secondary_button_color",
      "label": "Secondary Button Color",
      "default": "#e0e0e0"
    }
  ]
}
{% endschema %}

